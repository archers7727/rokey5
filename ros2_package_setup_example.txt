# ================================================================
# ROS2 패키지 생성 및 설정 가이드
# ================================================================

## 1. 패키지 생성

cd ~/ros2_ws/src
ros2 pkg create --build-type ament_python parking_controller --dependencies rclpy std_msgs


## 2. 디렉토리 구조

parking_controller/
├── package.xml
├── setup.py
├── resource/
│   └── parking_controller
├── parking_controller/
│   ├── __init__.py
│   └── exit_controller.py  ← ros2_node_example.py 복사
└── test/


## 3. setup.py 수정

from setuptools import setup

package_name = 'parking_controller'

setup(
    name=package_name,
    version='0.0.1',
    packages=[package_name],
    data_files=[
        ('share/ament_index/resource_index/packages',
            ['resource/' + package_name]),
        ('share/' + package_name, ['package.xml']),
    ],
    install_requires=[
        'setuptools',
        'supabase>=2.0.0',  # ← Supabase 의존성 추가
    ],
    zip_safe=True,
    maintainer='your_name',
    maintainer_email='your_email@example.com',
    description='Parking exit controller',
    license='MIT',
    tests_require=['pytest'],
    entry_points={
        'console_scripts': [
            'exit_controller = parking_controller.exit_controller:main',
        ],
    },
)


## 4. package.xml 수정

<?xml version="1.0"?>
<?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypens="http://www.w3.org/2001/XMLSchema"?>
<package format="3">
  <name>parking_controller</name>
  <version>0.0.1</version>
  <description>Parking exit controller with Supabase integration</description>
  <maintainer email="your@email.com">Your Name</maintainer>
  <license>MIT</license>

  <!-- ROS2 의존성 -->
  <depend>rclpy</depend>
  <depend>std_msgs</depend>

  <!-- Python 의존성 (시스템 레벨) -->
  <exec_depend>python3-pip</exec_depend>

  <test_depend>ament_copyright</test_depend>
  <test_depend>ament_flake8</test_depend>
  <test_depend>ament_pep257</test_depend>
  <test_depend>python3-pytest</test_depend>

  <export>
    <build_type>ament_python</build_type>
  </export>
</package>


## 5. 빌드 및 실행

# 빌드
cd ~/ros2_ws
colcon build --packages-select parking_controller

# 환경 설정
source install/setup.bash

# 환경 변수 설정
export SUPABASE_URL='https://your-project.supabase.co'
export SUPABASE_ANON_KEY='your-anon-key'

# 실행
ros2 run parking_controller exit_controller


## 6. 커스텀 메시지 타입 만들기 (선택 사항)

# 메시지 패키지 생성
ros2 pkg create --build-type ament_cmake parking_msgs

# parking_msgs/msg/ExitCommand.msg 파일 생성:
---
string gate_id
int32 vehicle_count
int32 duration_seconds
string parking_spot_id
builtin_interfaces/Time timestamp
---

# parking_msgs/CMakeLists.txt 수정:
find_package(rosidl_default_generators REQUIRED)

rosidl_generate_interfaces(${PROJECT_NAME}
  "msg/ExitCommand.msg"
  DEPENDENCIES builtin_interfaces
)

# parking_msgs/package.xml 수정:
<buildtool_depend>rosidl_default_generators</buildtool_depend>
<exec_depend>rosidl_default_runtime</exec_depend>
<member_of_group>rosidl_interface_packages</member_of_group>

# 빌드
colcon build --packages-select parking_msgs

# parking_controller에서 사용:
# package.xml에 추가:
<depend>parking_msgs</depend>

# exit_controller.py에서:
from parking_msgs.msg import ExitCommand


## 7. 토픽 확인

# 토픽 목록
ros2 topic list

# 토픽 내용 확인
ros2 topic echo /parking/exit_command

# 토픽 정보
ros2 topic info /parking/exit_command


## 8. 환경 변수를 launch 파일로 관리 (추천)

# parking_controller/launch/exit_controller.launch.py 생성:

from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, SetEnvironmentVariable
from launch.substitutions import LaunchConfiguration
from launch_ros.actions import Node

def generate_launch_description():
    return LaunchDescription([
        # 환경 변수 설정
        DeclareLaunchArgument('supabase_url',
            default_value='https://your-project.supabase.co'),
        DeclareLaunchArgument('supabase_key',
            default_value='your-anon-key'),

        SetEnvironmentVariable('SUPABASE_URL',
            LaunchConfiguration('supabase_url')),
        SetEnvironmentVariable('SUPABASE_ANON_KEY',
            LaunchConfiguration('supabase_key')),

        # 노드 실행
        Node(
            package='parking_controller',
            executable='exit_controller',
            name='exit_controller',
            output='screen',
        ),
    ])

# 실행:
ros2 launch parking_controller exit_controller.launch.py


## ================================================================
## 요약
## ================================================================

1. requirements-ros2.txt 내용 → setup.py의 install_requires에 복사
2. colcon build 하면 자동으로 pip 패키지 설치됨
3. 환경 변수는 launch 파일로 관리하는 것이 좋음
4. 커스텀 메시지는 선택사항 (String으로도 충분)
